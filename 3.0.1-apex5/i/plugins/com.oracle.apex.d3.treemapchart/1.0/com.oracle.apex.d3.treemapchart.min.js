!function(util,server,$,d3){var LEGEND_COLUMN_WIDTH=200;com_oracle_apex_d3_treemap_start=function(pRegionId,pAjaxId,pColors,pColorsFg,pConfig,pMinAR,pMaxAR,pMinHeight,pMaxHeight,pPageItemsSubmit,pShowTooltip,pTooltipSeries,pTooltipCustom,pTooltipValue,pShowLegend,pLegendPosition){function _fireApexEvent(e,d){apex.event.trigger($x(pRegionId),"com_oracle_apex_d3_"+e,d)}function _sortDataToGetGroupings(data){return oracle.jql().select([function(rows){return colorAccessor(rows[0])},"color"]).from(gPack.nodes(data).filter(function(d){return""!=d.COLORVALUE})).group_by([function(row){return row.COLORVALUE},"classifications"])()}function _assignThemeRollerClassesToObject(object,arguments){d3.select(object).classed("u-Color-"+gClassScale(arguments[0].COLORVALUE)+"-BG--bg u-Color-"+gClassScale(arguments[0].COLORVALUE)+"-FG--txt",!0)}function _buildHierarchy(pData){function _buildHierarchy_core(pData,pRootParentId,pDepth){var lrow,ix,target=[];if(pRootParentId in arrayOfParentsAndTheirChilds)for(var i=0;i<arrayOfParentsAndTheirChilds[pRootParentId].length;i++)lrow={},ix=arrayOfIdsAndSequence[arrayOfParentsAndTheirChilds[pRootParentId][i]],lrow.ID=pData.row[ix].ID,lrow.SIZEVALUE=pData.row[ix].SIZEVALUE,lrow.DEPTH=pDepth,lrow.COLORVALUE=pData.row[ix].COLORVALUE,lrow.LABEL=pData.row[ix].LABEL,lrow.TOOLTIP=pData.row[ix].TOOLTIP,lrow.LINK=pData.row[ix].LINK,lrow.ROWNUM=ix,lrow.children=_buildHierarchy_core(pData,pData.row[ix].ID,pDepth+1),target.push(lrow);return target}for(var arrayOfIdsAndSequence=[],arrayOfParentsAndTheirChilds=[],rootId="com_oracle_apex_d3_treemap_node_id_"+pRegionId,parentIdOfRoot="parent_com_oracle_apex_d3_treemap_node_id_"+pRegionId,newRoot={PARENT_ID:parentIdOfRoot,ID:rootId,SIZEVALUE:1,COLORVALUE:"",DEPTH:0,LABEL:"ROOT"},i=0;i<pData.row.length;i++)arrayOfIdsAndSequence[pData.row[i].ID]=i;for(var i=0;i<pData.row.length;i++)pData.row[i].PARENT_ID in arrayOfIdsAndSequence&&pData.row[i].ID!=pData.row[i].PARENT_ID||(pData.row[i].PARENT_ID=rootId);pData.row.push(newRoot),arrayOfIdsAndSequence[rootId]=pData.row.length-1;for(var i=0;i<pData.row.length;i++)pData.row[i].PARENT_ID in arrayOfParentsAndTheirChilds||(arrayOfParentsAndTheirChilds[pData.row[i].PARENT_ID]=[]),arrayOfParentsAndTheirChilds[pData.row[i].PARENT_ID].push(pData.row[i].ID);return _buildHierarchy_core(pData,parentIdOfRoot,0)}function _getTextWidth(object){var prevText=object.text();object.text("");var appendedObject=object.append("span").text(prevText),width=$(object.node()).find("span:first").width();return appendedObject.remove(),width}function _textEllipsis(object,d){var self=d3.select(object);self.text(d.LABEL);for(var textLength=_getTextWidth(self),text=d.LABEL;textLength>d.dx-12&&text.length>0;)text=text.slice(0,-1),self.text(text),textLength=_getTextWidth(self);return text.length<d.LABEL.length&&text.length>0?text+"...":text}function _initializeLegend(data,width){gAry=d3.oracle.ary().hideTitle(!0).showValue(!1).leftColor(!0).numberOfColumns(Math.max(Math.floor(width/LEGEND_COLUMN_WIDTH),1)).accessors({color:function(d){return d.color},label:function(d){return d.classifications}}).symbol("circle"),d3.select(gLegend$.get(0)).datum(data).call(gAry).selectAll(".a-D3ChartLegend-item").each(function(d){d3.select(this).selectAll(".a-D3ChartLegend-item-color").each(function(){for(var self=d3.select(this),colorClass=self.attr("class").match(/u-Color-\d+-BG--bg/g)||[],i=colorClass.length-1;i>=0;i--)self.classed(colorClass[i],!1);self.classed("u-Color-"+gClassScale(d.classifications)+"-BG--bg",!0)})})}function _mouseOverTooltip(object,d){pShowTooltip&&(gTooltipColor=window.getComputedStyle(object).getPropertyValue("background-color"),d3.select(gTooltip$.get(0)).datum(d).call(gTooltipGenerator),gTooltip$.stop().fadeIn(100),gTooltip$.position({my:"left+20 center",of:d3.event,at:"right center",within:gRegion$,collision:"flip fit"}))}function _mouseOverEffect(node,d){var hlnode=node.filter(function(d1){return d1.ID==d.ID});hlnode.style({opacity:config.opacity_highlight}),_fireApexEvent("mouseover",d)}function _mouseMoveEffect(node,d){_mouseOverEffect(node,d),_fireApexEvent("mouseover",d)}function _mouseOutEffect(node,d){var hlnode=node.filter(function(d1){return d1.ID==d.ID});hlnode.style({opacity:config.opacity_normal}),_fireApexEvent("mouseout",d)}function _hideTooltip(){pShowTooltip&&gTooltip$.stop().fadeOut(100)}function _linkEvent(d){if(d.LINK){var win=apex.navigation.redirect(d.LINK);win.focus()}_fireApexEvent("click",d)}function _bindEvents(node){node.on("mouseover",function(d){_mouseOverTooltip(this,d),_mouseOverEffect(node,d)}),node.on("mousemove",function(d){_mouseOverTooltip(this,d),_mouseMoveEffect(node,d)}),node.on("mouseout",function(d){_hideTooltip(),_mouseOutEffect(node,d)}),node.on("click",function(d){_linkEvent(d)})}function _recommendedHeight(){var minAR=pMinAR,maxAR=pMaxAR,w=gChart$.width(),h=0===gChart$.height()?w/maxAR:gChart$.height(),ar=w/h;return minAR>ar?h=w/maxAR+1:ar>maxAR&&(h=w/minAR-1),Math.max(pMinHeight,Math.min(pMaxHeight,h))}function _resizeFunction(){gContainer.style({width:"",height:""});var height=_recommendedHeight(),width=gChart$.width();gContainer.style({width:width+"px",height:height+"px"});var node=gContainer.selectAll(".com_oracle_apex_d3_treemap_node");gPack.size([width,height]),gPack.nodes(gData),node.transition().duration(config.trdur).style("left",function(d){return d.x+"px"}).style("top",function(d){return d.y+"px"}).style("width",function(d){return Math.max(0,d.dx-1)+"px"}).style("height",function(d){return Math.max(0,d.dy-1)+"px"}).text(function(d){return d.children?"":_textEllipsis(this,d)});var classifications=_sortDataToGetGroupings(gData);pShowLegend&&pLegendPosition&&_initializeLegend(classifications,width)}function _refreshData(d3json){{var width=gChart$.width();_recommendedHeight()}gData=_buildHierarchy(d3json)[0];var classifications=_sortDataToGetGroupings(gData),node=gContainer.selectAll(".com_oracle_apex_d3_treemap_node").data(gPack.nodes(gData).filter(function(d){return 0!=d.DEPTH}),function(d){return d.ID}),nodeEnter=node.enter().append("div").attr("class","com_oracle_apex_d3_treemap_node").text(function(d){return d.children?"":_textEllipsis(this,d)}).style({"background-color":colorAccessor,color:fgColorAccessor,opacity:config.opacity_normal,position:"absolute",overflow:"hidden","z-index":function(d){return d.DEPTH},left:function(d){return d.x+"px"},top:function(d){return d.y+"px"},width:"0px",height:"0px"});nodeEnter.transition().duration(config.trdur).style({width:function(d){return Math.max(0,d.dx-1)+"px"},height:function(d){return Math.max(0,d.dy-1)+"px"}}),nodeEnter.filter(function(d){return!d.children}).on("click",function(d){_linkEvent(d)}),pShowTooltip&&gTooltip$.hide();var nodeFilter=nodeEnter.filter(function(d){return!d.children});_bindEvents(nodeFilter),gColorScale||nodeFilter.each(function(){_assignThemeRollerClassesToObject(this,arguments)}),node.transition().duration(2*config.trdur).text(function(d){return d.children?"":_textEllipsis(this,d)}).style({"background-color":colorAccessor,color:fgColorAccessor,position:"absolute","z-index":function(d){return d.DEPTH},left:function(d){return d.x+"px"},top:function(d){return d.y+"px"},width:function(d){return Math.max(0,d.dx-1)+"px"},height:function(d){return Math.max(0,d.dy-1)+"px"}}),node.filter(function(d){return!d.children}).on("click",function(d){_linkEvent(d)}),node.exit().transition().duration(config.trdur).style({width:"0px",height:"0px"}).remove(),pShowLegend&&pLegendPosition&&_initializeLegend(classifications,width)}function _draw(d3json){gRegion$=$("#"+pRegionId+"_region"),gChart$=$("#"+pRegionId+"_chart"),gChart$.css("overflow","hidden");var width=gChart$.width(),height=_recommendedHeight();gPack=d3.layout.treemap().size([width,height]).sort(function(a,b){return b.rownum-a.rownum}).value(function(d){return d.SIZEVALUE}).children(function(d){return d.children}).padding(0),gContainer=d3.select(gChart$.get(0)).append("div").style({position:"relative",left:"0px",right:"0px",width:width+"px",height:height+"px"}),gData=_buildHierarchy(d3json)[0];var classifications=_sortDataToGetGroupings(gData),node=gContainer.selectAll(".com_oracle_apex_d3_treemap_node").data(gPack.nodes(gData)).enter().append("div").attr("class","com_oracle_apex_d3_treemap_node").text(function(d){return d.children?"":_textEllipsis(this,d)}).style({"background-color":colorAccessor,color:fgColorAccessor,opacity:0,overflow:"hidden","z-index":function(d){return d.DEPTH},position:"absolute",left:function(d){return d.x+"px"},top:function(d){return d.y+"px"},width:function(d){return Math.max(0,d.dx-1)+"px"},height:function(d){return Math.max(0,d.dy-1)+"px"}});gColorScale||node.each(function(){_assignThemeRollerClassesToObject(this,arguments)});var nodeFilter=node.filter(function(d){return!d.children});nodeFilter.transition().style("opacity",config.opacity_normal).duration(config.trdur),pShowTooltip&&(gTooltip$=$("<div>").addClass("a-D3Tooltip a-D3TreeMapChart-tooltip").appendTo(gChart$).hide()),_bindEvents(nodeFilter),$(window).on("apexwindowresized",_resizeFunction),pShowLegend&&pLegendPosition&&(gLegend$=$("<div>"),"TOP"==pLegendPosition?gChart$.before(gLegend$):gChart$.after(gLegend$),_initializeLegend(classifications,width)),apex.jQuery("#"+pRegionId).bind("apexrefresh",function(){_getData(_refreshData)}),apex.event.trigger($x(pRegionId),"com_oracle_apex_d3_initialized")}function _getData(f){apex.server.plugin(pAjaxId,{pageItems:pPageItemsSubmit},{success:f,dataType:"json"})}var gRegion$,gChart$,gTooltip$,gLegend$,gContainer,gPack,gTooltipColor,gData,gColorScale,gColorScaleForeground,gAry,gClassScale=d3.scale.ordinal().range(d3.range(1,16)),gTooltipGenerator=d3.oracle.tooltip().accessors({label:function(d){return pTooltipSeries?d.COLORVALUE:void 0},value:null,color:function(){return gTooltipColor},content:function(d){var string="";return pTooltipCustom&&(string+=d.TOOLTIP+" \n"),pTooltipValue&&(string+=d.SIZEVALUE),string}}).symbol("circle");gColorScale=pColors?d3.scale.ordinal().range(pColors.split(":")):void 0,gColorScaleForeground=pColorsFg?d3.scale.ordinal().range(pColorsFg.split(":")):void 0;var colorAccessor=function(d){return gColorScale?gColorScale(d.COLORVALUE):null},fgColorAccessor=function(d){return gColorScaleForeground?gColorScaleForeground(d.COLORVALUE):null},config={trdur:500,opacity_normal:"0.8",opacity_highlight:"1.0"},dConfig="";try{dConfig=JSON.parse(pConfig)}catch(e){dConfig={}}for(var attrname in dConfig)config[attrname]=dConfig[attrname];_getData(_draw)}}(apex.util,apex.server,apex.jQuery,d3);